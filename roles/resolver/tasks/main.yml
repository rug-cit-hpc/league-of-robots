---
- name: Install dnsmasq
  yum:
    state: latest
    update_cache: yes
    name:
      - dnsmasq
  become: true
  notify: restart_dnsmasq

- name: Configure /etc/dnsmasq.conf to use nameservers as listed in group_vars for this cluster.
  template:
    dest: '/etc/dnsmasq.conf'
    src: 'templates/dnsmasq.conf.j2'
    owner: root
    group: root
    mode: 0644
  become: true
  notify: restart_dnsmasq

- name: Configure /etc/resolv.conf to use dnsmasq on localhost.
  copy:
    dest: '/etc/resolv.conf'
    content: nameserver 127.0.0.1
    owner: root
    group: root
    mode: 0644
  become: true
  notify: restart_dnsmasq

- name: Enable dnsmasq service.
  systemd:
    name: 'dnsmasq.service'
    enabled: yes
  become: true
  notify: restart_dnsmasq

- cron:
    # dnsmasq sometimes stops resolving.
    # See issue #100
    name: Restart dnsmasq service.
    minute: "/10"
    user: root
    job: /bin/systemctl restart dnsmasq
    cron_file: restart_dnsmasq
  become: true

- meta: flush_handlers
...
